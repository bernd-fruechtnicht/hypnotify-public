name: Deploy iOS

on:
  push:
    branches: [main, 'feature/**']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

permissions:
  contents: read

jobs:
  quality-checks:
    uses: ./.github/workflows/reusable-quality-checks.yml
    with:
      skip_build_check: true

  build-ios:
    name: Build iOS
    needs: quality-checks
    uses: ./.github/workflows/reusable-eas-build.yml
    # Build nur bei [deploy ios] auf main oder manuell
    # Auf Feature-Branches: Nur Quality Checks, kein Build
    if: |
      (github.ref == 'refs/heads/main' && 
       (contains(github.event.head_commit.message, '[deploy ios]') ||
        contains(github.event.head_commit.message, '[deploy]'))) ||
      github.event_name == 'workflow_dispatch'
    with:
      platform: 'ios'
      profile: ${{ github.event.inputs.profile || 'production' }}
    secrets:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  # Note: Submit to App Store Connect is done manually via:
  # npx eas-cli submit --platform ios --profile production
  #
  # Note: Lokale Builds sind weiterhin m√∂glich:
  # npx eas-cli build --platform ios --profile production
