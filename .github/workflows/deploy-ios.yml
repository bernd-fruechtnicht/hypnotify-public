name: Deploy iOS

on:
  workflow_run:
    workflows: ['Quality Checks']
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

permissions:
  contents: read

jobs:
  # Quality Checks bei workflow_dispatch (manueller Trigger, nur von main)
  # Bei workflow_run werden Quality Checks bereits vom Quality Checks Workflow ausgeführt
  quality-checks:
    name: Quality Checks
    uses: ./.github/workflows/reusable-quality-checks.yml
    if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'

  build-ios:
    name: Build iOS App
    # Warte auf Quality Checks (bei workflow_dispatch) oder auf workflow_run
    # Build nur von main Branch (sowohl bei workflow_run als auch workflow_dispatch)
    # Bei workflow_run: Nur bei [deploy ios] in Commit-Message (nur auf main)
    needs:
      - quality-checks
    uses: ./.github/workflows/reusable-eas-build.yml
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_commit &&
       github.event.workflow_run.head_branch == 'main' &&
       (contains(github.event.workflow_run.head_commit.message, '[deploy ios]') ||
        contains(github.event.workflow_run.head_commit.message, '[deploy]'))) ||
      (github.event_name == 'workflow_dispatch' &&
       github.ref == 'refs/heads/main' &&
       needs.quality-checks.result == 'success')
    with:
      platform: 'ios'
      profile: ${{ github.event.inputs.profile || 'production' }}
    secrets:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  # Note: Submit to App Store Connect is done manually via:
  # npx eas-cli submit --platform ios --profile production
  #
  # Note: Lokale Builds sind weiterhin möglich:
  # npx eas-cli build --platform ios --profile production
