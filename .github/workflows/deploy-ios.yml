name: Deploy iOS

on:
  workflow_run:
    workflows: ['Quality Checks']
    types:
      - completed
    branches: [main, 'feature/**']
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

permissions:
  contents: read

jobs:
  build-ios:
    name: Build iOS
    # Warte auf Quality Checks Workflow (bei workflow_run)
    # Oder manuell via workflow_dispatch
    # Auf Feature-Branches: Workflow wird getriggert (zum Testen), aber Build wird übersprungen
    # Auf Main: Build nur bei [deploy ios] in Commit-Message
    uses: ./.github/workflows/reusable-eas-build.yml
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_commit &&
       github.event.workflow_run.head_branch == 'main' &&
       (contains(github.event.workflow_run.head_commit.message, '[deploy ios]') ||
        contains(github.event.workflow_run.head_commit.message, '[deploy]'))) ||
      github.event_name == 'workflow_dispatch'
    with:
      platform: 'ios'
      profile: ${{ github.event.inputs.profile || 'production' }}
    secrets:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  # Note: Submit to App Store Connect is done manually via:
  # npx eas-cli submit --platform ios --profile production
  #
  # Note: Lokale Builds sind weiterhin möglich:
  # npx eas-cli build --platform ios --profile production
